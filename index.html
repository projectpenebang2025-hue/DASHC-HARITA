<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Form Daily Input Ritase â€“ Offline</title>
<meta name="theme-color" content="#0f172a">
<link rel="manifest" href="manifest.json" />
<!-- Font elegan untuk nama perusahaan -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ==== CSS (tidak dihapus apapun) ==== */
:root{
  --bg:#0f172a;
  --card:rgba(17,24,39,0.7);
  --muted:#94a3b8;
  --text:#e5e7eb;
  --accent:#22c55e;
  --accent-2:#38bdf8;
  --danger:#ef4444;
  --warning:#f59e0b;
  --border:rgba(255,255,255,0.08);
  --shadow:0 8px 25px rgba(0,0,0,0.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(160deg,#0b1020,#0f172a 60%,#111827);
  color:var(--text);
  font:16px/1.5 "Inter",system-ui,Segoe UI,Roboto,Arial;
}
.container{max-width:1100px;margin:24px auto;padding:16px}
.grid{display:grid;gap:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:20px;
  padding:20px;
  backdrop-filter:blur(12px) saturate(160%);
  box-shadow:0 8px 25px rgba(0,0,0,0.35);
  transition:transform .2s ease,box-shadow .3s ease;
}
.card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.45)}
h1{font-size:24px;margin:0 0 10px;font-weight:600}
h2{font-size:18px;margin:0 0 14px;color:var(--muted);font-weight:500}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button{
  width:100%;padding:10px 12px;border-radius:12px;
  border:1px solid var(--border);background:#0b1222;color:var(--text);
  transition:all .2s ease;
}
input[type=number]{appearance:textfield}
input:focus,select:focus{
  outline:none;
  border-color:var(--accent-2);
  box-shadow:0 0 0 2px rgba(56,189,248,.4);
}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.col-3{grid-column:span 3}
.col-4{grid-column:span 4}
.col-6{grid-column:span 6}
.col-8{grid-column:span 8}
.col-12{grid-column:span 12}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{
  cursor:pointer;border:none;font-weight:600;
  padding:10px 16px;border-radius:12px;transition:all .2s ease;
}
.btn.primary{background:var(--accent);color:#052e16}
.btn.primary:hover{background:#16a34a}
.btn.secondary{background:#0b1222;border:1px solid var(--border)}
.btn.secondary:hover{background:#1e293b}
.btn.warn{background:var(--warning);color:#1f1300}
.btn.warn:hover{background:#d97706}
.btn.danger{background:var(--danger)}
.btn.danger:hover{background:#dc2626}
.table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto}
.table th,.table td{
  padding:10px 8px;border-bottom:1px solid var(--border);
  text-align:left;font-size:14px
}
.table th{color:var(--muted);font-weight:600}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
.badge.s1{background:#0b3b1d;color:#86efac;border:1px solid #14532d}
.badge.s2{background:#132a46;color:#93c5fd;border:1px solid #1e3a8a}
.muted{color:var(--muted)}
.right{display:flex;justify-content:flex-end}
.nowrap{white-space:nowrap}
.footer{margin-top:18px;font-size:12px;color:var(--muted);text-align:center}
.chip{
  background:#0b1222;border:1px solid var(--border);
  padding:6px 12px;border-radius:999px;font-size:13px
}
.filters{display:flex;gap:8px;flex-wrap:wrap}
@media (max-width:800px){
  .row{grid-template-columns:1fr}
  .col-3,.col-4,.col-6,.col-8,.col-12{grid-column:span 1}
}
.action-bar {
  margin-top: 32px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding-top: 20px;
  border-top: 1px dashed var(--border);
}
body {
  height: 100%;
  background-color: #0f172a; /* warna gelap cadangan */
  background: url('Generated_Image.png') no-repeat center center fixed;
  background-size: 110%; /* biar gak terlalu zoom */
  background-position: center top;
  background-attachment: fixed;
  color: #f9fafb;
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 0;
}

/* Pastikan elemen pembungkus utama ikut gelap */
main, .container, .content, #app {
  background: transparent;
}

@media (max-width: 768px) {
  body {
    background-attachment: scroll;
    background-position: center center;
  }
}


body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45); /* lapisan gelap transparan */
  z-index: -1;
}

/* Overlay biar gradasi bawah gelap */
body::after {
  content: "";
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 200px;
  background: linear-gradient(to bottom, rgba(15,23,42,0) 0%, rgba(15,23,42,1) 100%);
  pointer-events: none;
  z-index: -1;
}


/* Elemen info biar tetap elegan di atas background */
#lokasiInfo {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  color: white;
  border-radius: 12px;
  padding: 8px 14px;
  position: absolute;
  top: 135px;
  right: 40px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  font-size: 13px;
  transition: all 0.3s ease;
}

#lokasiInfo:hover {
  transform: translateY(-2px);
  opacity: 1;
}

.small-input {
  font-size: 16px;
  transform: scale(0.9);
  transform-origin: left center;
}

  /* --- Cegah auto zoom di input saat diklik di HP --- */
@media (max-width: 768px) {
  input,
  select,
  textarea {
    font-size: 16px !important; /* batas aman biar HP gak zoom */
  }
}


/* Biar hasil output loader/hauler gak kayak balon di HP */
.chip {
  display: inline-block;
  font-size: 14px;           /* kecilin tulisan */
  padding: 6px 10px;         /* kurangi ruang dalam */
  border-radius: 4px;
  background: #0f172a;       /* sama kayak tema gelap */
  color: #fff;
  text-align: center;
  width: 100%;
  box-sizing: border-box;
  word-break: break-word;    /* biar gak keluar layar */
  white-space: normal;
}

/* biar gak membesar pas diklik di HP */
.chip:focus {
  outline: none;
  transform: scale(1);
}



/* ==== LOGO & NAMA PERUSAHAAN ==== */
/* ==== FONT OVIDIUS SCRIPT ==== */
@font-face {
  font-family: 'Ovidius Script';
  src: url('OvidiusScript.ttf') format('truetype');
  font-display: swap;
}

#headerLogo {
  position: sticky;
  top: 0;
  left: 0;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 999;
  background: rgba(15,23,42,0.85);
  padding: 14px 24px;
  border-bottom: 2px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
}

/* Logo agak lebih besar dan kontras */
#logoPerusahaan {
  height: 90px;
  width: auto;
  border-radius: 10px;
  background: #fff;
  padding: 6px;
  box-shadow: 0 0 12px rgba(255,255,255,0.2),
              0 0 18px rgba(0,0,0,0.35);
  transition: all 0.3s ease;
}

/* Nama perusahaan tampil elegan & mewah */
#namaPerusahaan {
  font-family: 'Ovidius Script', cursive;
  font-size: 36px;
  font-weight: 500;
  letter-spacing: 1.2px;
  color: #f8f8f8;
  text-shadow: 0 0 6px rgba(255, 255, 255, 0.4),
               0 0 10px rgba(200, 200, 255, 0.25);
  transition: all 0.3s ease;
}

/* Tambahkan ruang agar konten gak ketiban */
.container {
  max-width: 1100px;
  margin: 150px auto 24px auto;
  padding: 16px;
}

/* ==== Responsif ==== */
@media (max-width: 768px) {
  #headerLogo {
    padding: 10px 16px;
    gap: 10px;
  }
  #logoPerusahaan { height: 70px; }
  #namaPerusahaan { font-size: 26px; }
  .container { margin-top: 110px; }
}

@media (max-width: 480px) {
  #headerLogo {
    padding: 8px 10px;
    gap: 8px;
  }
  #logoPerusahaan { height: 55px; }
  #namaPerusahaan { font-size: 20px; }
  .container { margin-top: 95px; }
}



input,select,button{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#0b1222;
  color:var(--text);
  transition:all .2s ease;
  font-size:16px;
}

/* ==== MODAL POPUP ==== */
#popupModal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-width: 250px;
  max-width: 90%;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  color: var(--text);
  padding: 20px;
  display: none;
  z-index: 9999;
  text-align: center;
}
#popupModal .icon {
  font-size: 36px;
  margin-bottom: 12px;
}
#popupModal .icon.success { color: #22c55e; }
#popupModal .icon.error { color: #ef4444; }
#popupModal .msg { font-size: 16px; margin-bottom: 12px; }
#popupModal .closeBtn {
  cursor: pointer;
  background: #1e293b;
  color: var(--text);
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  transition: all .2s ease;
}
#popupModal .closeBtn:hover { background: #111827; }

/* ==== POPUP KONFIRMASI MODERN ==== */
#popupConfirm {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(3px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}
#popupConfirm.active { opacity: 1; pointer-events: auto; }
#popupConfirm .content {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  min-width: 250px;
  max-width: 90%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
}
#popupConfirm .content .actions {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 10px;
}

/* === Loader Switcher Bar (Horizontal + Elegan) === */
#loaderSwitcher {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  flex-wrap: nowrap;
  overflow-x: auto;
  background: rgba(15, 23, 42, 0.7);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  margin: 16px auto 18px auto;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
  scrollbar-width: none;
}
#loaderSwitcher::-webkit-scrollbar {
  display: none;
}

/* === Tombol Loader === */
/* === Wrapper untuk Loader Tabs === */
#loaderTabs {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* Satu unit loader (hapus + hijau) */
.loaderItem {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Tombol hapus (balok kiri, terpisah) */
.removeBtn {
  background: rgba(220,38,38,0.25);
  border: 1px solid rgba(220,38,38,0.4);
  color: #fff;
  font-size: 16px;
  border-radius: 10px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.25s ease;
  font-weight: 600;
}

.removeBtn:hover {
  background: rgba(220,38,38,0.5);
  transform: scale(1.05);
}

/* Kotak hijau loader */
.loaderTab {
  background: #16a34a;
  color: white;
  padding: 10px 40px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 10px #16a34a88;
  transition: all 0.25s ease;
  text-align: center;
  min-width: 120px;       /* ukuran tetap */
  white-space: nowrap;    /* teks gak pecah */
}

.loaderTab.active {
  background: #22c55e;
  box-shadow: 0 0 12px #22c55e88;
}

/* Tombol tambah (+) */
#addLoaderBtn {
  background: rgba(148,163,184,.25);
  border: 1px solid var(--border);
  color: #f8fafc;
  font-size: 20px;
  padding: 8px 18px;
  border-radius: 10px;
  cursor: pointer;
  transition: all .25s ease;
  font-weight: 600;
}

#addLoaderBtn:hover {
  background: rgba(22,163,74,0.4);
  transform: scale(1.05);
}

#resetLoaderBtn {
  background-color: #dc2626; /* merah elegan */
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

#resetLoaderBtn:hover {
  background-color: #ef4444; /* merah lebih terang saat hover */
  transform: scale(1.03);
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
}





</style>
</head>
<body>

<!-- ðŸ¢ Logo & Nama Perusahaan -->
<div id="headerLogo">
  <img src="logo-harita-group.jpg" alt="Logo Harita Group" id="logoPerusahaan">
  <span id="namaPerusahaan"><span style="letter-spacing:3px;">PT&nbsp;</span> Kayong Aluminium Nusantara</span>
</div>


<div id="lokasiInfo">GPS: mencari...</div>
<div class="container grid">
<!-- FORM INPUT -->
<div class="card">
<h1>Form Daily Input Ritase</h1>
<h2>Waktu & lokasi tercatat otomatis</h2>
<div class="row">
<div class="col-4">
<label>Shift</label>
<div class="actions">
<button class="btn secondary" id="btnShift1" onclick="setShift(1)">Shift 1</button>
<button class="btn secondary" id="btnShift2" onclick="setShift(2)">Shift 2</button>
<span id="shiftNow" class="chip">Aktif: 1</span>
</div>
</div>
<div class="col-4">
<label>Tanggal (otomatis)</label>
<input id="tanggalNow" type="text" disabled />
</div>
<div class="col-4">
<label>Jam (otomatis)</label>
<input id="jamNow" type="text" disabled />
</div>
</div>

<!-- === TAMBAHAN CHECKER: pilih sekali, tersimpan === -->
<div class="row" style="margin-top:8px">
  <div class="col-4">
    <label>ID Checker</label>
    <select id="checkerId" onchange="setCheckerId(this.value)">
      <option value="">-- Pilih ID --</option>
      <option value="C01">C01</option>
      <option value="C02">C02</option>
      <option value="C03">C03</option>
      <option value="C04">C04</option>
      <option value="C05">C05</option>
      <option value="C06">C06</option>
      <option value="C07">C07</option>
      <option value="C08">C08</option>
      <option value="C09">C09</option>
      <option value="C10">C10</option>
      <option value="C01">C11</option>
      <option value="C02">C12</option>
      <option value="C03">C13</option>
      <option value="C04">C14</option>
      <option value="C05">C15</option>
      <option value="C06">C16</option>
      <option value="C07">C17</option>
      <option value="C08">C18</option>
      <option value="C09">C19</option>
      <option value="C10">C20</option>
      <option value="C01">C21</option>
      <option value="C02">C22</option>
      <option value="C03">C23</option>
      <option value="C04">C24</option>
      <option value="C05">C25</option>
      <option value="C06">C26</option>
      <option value="C07">C27</option>
      <option value="C08">C28</option>
      <option value="C09">C29</option>
      <option value="C10">C30</option>
    </select>
    <div class="chip" id="checkerNow">Belum dipilih</div>
  </div>
</div>
<!-- === /TAMBAHAN CHECKER === -->

<div id="loaderSwitcher">
  <div id="loaderTabs"></div>
  <button id="addLoaderBtn">+</button>
</div>

<div style="display:flex; gap:8px; margin-top:10px;">
  <button id="resetLoaderBtn">Reset Loader</button>
</div>


<div class="row" style="margin-top:8px">
    <div class="col-4">
    <label>Loader</label>
    <div style="display:flex;gap:6px">
      <select id="loaderPrefix" style="width:100px" onchange="updateLoaderHaulerOutput()">
        <option value="">--</option>
        <option value="AHG">AHG</option>
        <option value="AKs">AKs</option>
        <option value="BKM">BKM</option>
        <option value="BSS">BSS</option>
        <option value="HER">HER</option>
        <option value="KTU">KTU</option>
        <option value="LMP">LMP</option>
        <option value="PIK">PIK</option>
        <option value="WWP">WWP</option>
      </select>
      <input id="loaderNo" placeholder="001" 
      style="flex:1; font-size:16px; padding:6px 8px; border-radius:6px; box-sizing:border-box;" 
      oninput="updateLoaderHaulerOutput()" />
    </div>
    <div class="chip" id="loaderOutput" style="margin-top:6px;">â€“</div>
  </div>

  <div class="col-4">
    <label>Hauler</label>
    <div style="display:flex;gap:6px">
      <select id="haulerPrefix" style="width:100px" onchange="updateLoaderHaulerOutput()">
        <option value="">--</option>
        <option value="AHG">AHG</option>
        <option value="AKs">AKs</option>
        <option value="BKM">BKM</option>
        <option value="BSS">BSS</option>
        <option value="HER">HER</option>
        <option value="KTU">KTU</option>
        <option value="LMP">LMP</option>
        <option value="PIK">PIK</option>
        <option value="WWP">WWP</option>
      </select>
      <input id="haulerNo" placeholder="009"
      style="flex:1; font-size:16px; padding:6px 8px; border-radius:6px; box-sizing:border-box;"
      oninput="updateLoaderHaulerOutput()" />
    </div>
    <div class="chip" id="haulerOutput" style="margin-top:6px;">â€“</div>
  </div>

  <div class="col-4">
    <label>Location Front</label>
    <select id="front">
      <option value="">-- Pilih Location --</option>
      <option value="Aluminium">Aluminium</option>
      <option value="CY">Coal Yard</option>
      <option value="Living Quarter">Living Quarter</option>
      <option value="Power Plant">Power Plant</option>
      <option value="Stone Crusher">Stone Crusher</option>
    </select>
  </div>
  <div class="col-4">
    <label>Dumpingan</label>
    <input id="dump" placeholder="cth: Disposal 2" />
  </div>
  <div class="col-4">
    <label>Material</label>
    <select id="material">
      <option value="">-- Pilih Material --</option>
      <option value="Soil (A)">Soil (A)</option>
      <option value="Biomas (B)">Biomas (B)</option>
      <option value="Rock (C)">Rock (C)</option>
      <option value="Unblast (A+C)">Unblast (A+C)</option>
      <option value="Sand (D)">Sand (D)</option>
    </select>
  </div>
  <div class="col-4">
    <label>Jumlah Bucket</label>
    <input id="bucket" type="number" min="0" step="1" placeholder="0" />
  </div>
</div>
<div class="actions" style="margin-top:12px">
<button class="btn primary" onclick="simpan()">Simpan (Enter)</button>
<!-- <button class="btn secondary" onclick="resetForm()">Reset</button> -->
</div>
</div>

<!-- DATA TERSIMPAN -->
<div class="card">
<div class="row" style="align-items:end">
<div class="col-8">
<h2>Data Tersimpan</h2>
<div class="filters">
<select id="filterShift" onchange="render()">
<option value="">Semua Shift</option>
<option value="1">Shift 1</option>
<option value="2">Shift 2</option>
</select>
<input type="date" id="filterDate" onchange="render()" />
<button class="btn secondary" onclick="clearFilter()">Bersihkan Filter</button>
</div>
</div>
<div class="col-4 right">
<div class="chip" id="totalInfo">0 data</div>
</div>
</div>
<div style="overflow:auto;margin-top:8px">
<table class="table" id="tbl">
<thead>
<tr>
<th class="nowrap">#</th>
<th class="nowrap">Tanggal</th>
<th class="nowrap">Jam</th>
<th>Shift</th>
<!-- === TAMBAHAN CHECKER: kolom tabel === -->
<th>Checker</th>
<!-- === /TAMBAHAN CHECKER === -->
<th>Loader</th>
<th>Hauler</th>
<th>Location Front</th>
<th>Dumpingan</th>
<th>Material</th>
<th class="nowrap">Jumlah Bucket</th>
<th>Latitude</th>
<th>Longitude</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
<div style="margin-top:24px" class="actions far">
<button class="btn warn" onclick="exportCSVFiltered()">Export CSV</button>
<button class="btn danger" onclick="hapusSemua()">Hapus Semua</button>
</div>
<div class="footer">Data disimpan di browser (localStorage). Bisa dipakai offline.</div>
</div>
</div>

<!-- POPUP MODAL -->
<div id="popupModal">
  <div class="icon" id="popupIcon">âœ…</div>
  <div class="msg" id="popupMsg">Data tersimpan!</div>
  <button class="closeBtn" onclick="closePopup()">Tutup</button>
</div>

<!-- POPUP KONFIRMASI MODERN -->
<div id="popupConfirm">
  <div class="content">
    <div class="msg" id="confirmMsg">Apakah yakin ingin menghapus data ini?</div>
    <div class="actions">
      <button class="btn danger" id="confirmYes">Hapus</button>
      <button class="btn secondary" id="confirmNo">Batal</button>
    </div>
  </div>
</div>

<script>
// ==== SEMUA JS DI GABUNG DAN DIBENAHI URUTANNYA ====

// ==== UTILITAS WAKTU ====
const pad = n => String(n).padStart(2,'0');
function getTanggal(d=new Date()){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function getJam(d=new Date()){return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}

// ==== STATE ====
let SHIFT_AKTIF=1;
const KEY='produksi_data_v2';
let lokasiTerakhir={lat:null,lon:null};
const KEY_CHECKER='CHECKER_ID';

// ==== SHIFT ====
function setShift(n){
  SHIFT_AKTIF=(n===2)?2:1;
  document.getElementById('shiftNow').textContent=`Aktif: ${SHIFT_AKTIF}`;
  document.getElementById('btnShift1').style.outline=SHIFT_AKTIF===1?'2px solid var(--accent)':'none';
  document.getElementById('btnShift2').style.outline=SHIFT_AKTIF===2?'2px solid var(--accent)':'none';
  focusFirst();
}

// ==== CLOCK REALTIME ====
function tick(){
  const now=new Date();
  document.getElementById('tanggalNow').value=getTanggal(now);
  document.getElementById('jamNow').value=getJam(now);
}
setInterval(tick,1000);tick();

// ==== STORAGE ====
function load(){try{return JSON.parse(localStorage.getItem(KEY))||[];}catch{return[];}}
function save(arr){localStorage.setItem(KEY,JSON.stringify(arr));}

// ==== FORM ====
function focusFirst(){document.getElementById('loaderPrefix').focus();}
function getForm() {
  const now = new Date();
  const shiftInfo = getShiftAndTanggalKerja();

  const loaderPrefix = document.getElementById('loaderPrefix').value.trim();
  const loaderNo = document.getElementById('loaderNo').value.trim();
  const haulerPrefix = document.getElementById('haulerPrefix').value.trim();
  const haulerNo = document.getElementById('haulerNo').value.trim();

  // fungsi pencarian di master
  function findFullCode(prefix, code) {
    if (!prefix || !code) return '';
    const list = MASTER_UNITS[prefix];
    if (!list || list.length === 0) return `${prefix}-${code}`;
    const found = list.find(item => item.endsWith(`-${code.padStart(3, '0')}`));
    return found || `${prefix}-${code}`;
  }

  const loaderFull = findFullCode(loaderPrefix, loaderNo);
  const haulerFull = findFullCode(haulerPrefix, haulerNo);

  return {
    tanggal: shiftInfo.tanggal,
    jam: getJam(now),
    shift: shiftInfo.shift,
    checker: localStorage.getItem(KEY_CHECKER) || '',
    loader: loaderFull,
    hauler: haulerFull,
    front: document.getElementById('front').value,
    dump: document.getElementById('dump').value.trim(),
    material: document.getElementById('material').value.trim(),
    bucket: Number(document.getElementById('bucket').value || 0),
    lat: lokasiTerakhir.lat,
    lon: lokasiTerakhir.lon
  };
}

function valid(d){
  if(!d.loader)return'Loader wajib diisi';
  if(!d.hauler)return'Hauler wajib diisi';
  if(!d.front)return'Location Front wajib dipilih';
  if(isNaN(d.bucket)||d.bucket<0)return'Jumlah Bucket tidak valid';
  return'';
}
function resetForm(){
  // hanya reset kolom haulerNo dan bucket
  document.getElementById('haulerPrefix').value = '';
  document.getElementById('haulerNo').value = '';
  // document.getElementById('bucket').value = '';

  // tetap fokus ke kolom haulerNo biar cepat input lagi
  document.getElementById('haulerNo').focus();
}

function resetLoaderSemua() {
  // hapus semua loader
  loaderForms = {};
  localStorage.setItem('loader_forms', JSON.stringify(loaderForms));
  loaderAktif = null;

  // buat Loader-1 baru
  tambahLoaderBaru();

  // perbarui tampilan dan isi form
  updateLoaderTabs();
  isiFormDariLoader();
}

// pasang event listener
document.getElementById('resetLoaderBtn').addEventListener('click', resetLoaderSemua);

// === Load JSON master unit ===
let MASTER_UNITS = {};

fetch('Master_Unit.json')
  .then(res => res.json())
  .then(data => {
    MASTER_UNITS = data;
  })
  .catch(err => console.error("Gagal load Master_Unit.json:", err));

// === Fungsi Update Loader dan Hauler Output ===
function updateLoaderHaulerOutput() {
  const loaderGroup = document.getElementById('loaderPrefix').value.trim(); // contoh: AKs
  const loaderCode = document.getElementById('loaderNo').value.trim();      // contoh: 106

  const haulerGroup = document.getElementById('haulerPrefix').value.trim();
  const haulerCode = document.getElementById('haulerNo').value.trim();

  // Fungsi pencarian kode lengkap dari master unit
  function findFullCode(prefix, shortCode) {
    if (!prefix || !shortCode) return '';
    const list = MASTER_UNITS[prefix];
    if (!list || list.length === 0) return null;

    // Cari unit yang cocok dengan 3 digit terakhir
    const found = list.find(item => item.endsWith(`-${shortCode.padStart(3, '0')}`));
    return found || null;
  }

  const loaderFull = findFullCode(loaderGroup, loaderCode);
  const haulerFull = findFullCode(haulerGroup, haulerCode);

  // Update output
  document.getElementById('loaderOutput').textContent = loaderFull || `${loaderGroup}-${loaderCode}`;
  document.getElementById('haulerOutput').textContent = haulerFull || `${haulerGroup}-${haulerCode}`;
}



// ==== POPUP UTAMA ====
function showPopup(msg,type='success'){
  const modal=document.getElementById('popupModal');
  const icon=document.getElementById('popupIcon');
  const msgEl=document.getElementById('popupMsg');
  msgEl.textContent=msg;
  if(type==='success'){icon.textContent='âœ…';icon.className='icon success';}
  else{icon.textContent='âŒ';icon.className='icon error';}
  modal.style.display='block';
}
function closePopup(){document.getElementById('popupModal').style.display='none';}

// ==== POPUP KONFIRM ====
let confirmCallback=null;
function showConfirm(msg,cb){
  confirmCallback=cb;
  document.getElementById('confirmMsg').textContent=msg;
  document.getElementById('popupConfirm').classList.add('active');
}
function closeConfirm(){
  document.getElementById('popupConfirm').classList.remove('active');
  setTimeout(()=>{confirmCallback=null;},200);
}
document.getElementById('confirmYes').onclick=()=>{if(confirmCallback)confirmCallback(true);closeConfirm();}
document.getElementById('confirmNo').onclick=()=>{if(confirmCallback)confirmCallback(false);closeConfirm();}

// ==== PENENTUAN SHIFT & TANGGAL KERJA OTOMATIS ====
function getShiftAndTanggalKerja() {
  const now = new Date();
  const jam = now.getHours();
  const tanggalKerja = new Date(now);

  let shift;
  if (jam >= 6 && jam < 18) {
    // Shift 1: 06.00â€“17.59, tanggal sama
    shift = 1;
  } else {
    // Shift 2: 18.00â€“05.59
    shift = 2;
    if (jam >= 0 && jam < 6) {
      // Jam 00:00â€“05:59 â†’ tanggal kerja harus mundur 1 hari
      tanggalKerja.setDate(tanggalKerja.getDate() - 1);
    }
  }

  const yyyy = tanggalKerja.getFullYear();
  const mm = String(tanggalKerja.getMonth() + 1).padStart(2, '0');
  const dd = String(tanggalKerja.getDate()).padStart(2, '0');

  return {
    shift,
    tanggal: `${yyyy}-${mm}-${dd}`
  };
}


// ==== SIMPAN DATA ====
function simpan(){
  const d=getForm();const err=valid(d);
  if(err){showPopup(err,'error');return;}
  const arr=load();arr.push(d);save(arr);
  resetForm();render();
  showPopup('Data tersimpan!','success');
}
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&(document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='SELECT')){
    e.preventDefault();simpan();
  }
});

let loaderForms = JSON.parse(localStorage.getItem('loader_forms') || '{}');
let loaderAktif = null;

function updateLoaderTabs() {
  const container = document.getElementById('loaderTabs');
  container.innerHTML = '';

  Object.keys(loaderForms).forEach(id => {
    const loaderItem = document.createElement('div');
    loaderItem.className = 'loaderItem';

    // Tombol hapus (kiri)
    const removeBtn = document.createElement('button');
    removeBtn.className = 'removeBtn';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = (e) => hapusLoader(id, e);

    // Tombol switch loader
    const loaderTab = document.createElement('div');
    loaderTab.className = 'loaderTab';
    loaderTab.textContent = id.replace('Loader-', 'L');

    // Bedakan warna loader aktif / non-aktif
    if (id === loaderAktif) {
      loaderTab.style.backgroundColor = '#22c55e'; // hijau loader aktif
      loaderTab.style.color = '#fff';
    } else {
      loaderTab.style.backgroundColor = '#0f172a'; // hitam / gelap seperti background
      loaderTab.style.color = '#888'; // teks agak terlihat tapi tetap gelap
      loaderTab.style.border = '2px solid rgba(255,255,255,0.2)'; // garis tepi abu-abu tipis
    }

    loaderTab.onclick = () => switchLoader(id);

    loaderItem.appendChild(removeBtn);
    loaderItem.appendChild(loaderTab);
    container.appendChild(loaderItem);
  });
}


function tambahLoaderBaru() {
  const id = 'Loader-' + (Object.keys(loaderForms).length + 1);
  loaderForms[id] = {
    loaderPrefix: '', loaderNo: '', haulerPrefix: '', haulerNo: '',
    front: '', dump: '', material: '', bucket: ''
  };
  localStorage.setItem('loader_forms', JSON.stringify(loaderForms));
  loaderAktif = id;
  updateLoaderTabs();
  isiFormDariLoader();
}

function switchLoader(id) {
  if (id === loaderAktif) return; // biar gak reload sama loader
  simpanFormLoaderAktif();
  loaderAktif = id;
  updateLoaderTabs();
  isiFormDariLoader();
}

function hapusLoader(id, e) {
  e.stopPropagation(); // jangan ikut klik tab hijau
  if (id === 'Loader-1') {
    showPopup('Loader 1 tidak bisa dihapus sayang â¤ï¸', 'error');
    return;
  }

  showConfirm(`Yakin hapus ${id}?`, (ok) => {
    if (ok) {
      delete loaderForms[id];
      localStorage.setItem('loader_forms', JSON.stringify(loaderForms));
      const sisa = Object.keys(loaderForms);
      loaderAktif = sisa.length ? sisa[0] : null;
      updateLoaderTabs();
      if (loaderAktif) isiFormDariLoader();
      else resetForm();
      showPopup(`${id} dihapus!`, 'success');
    }
  });
}

function isiFormDariLoader() {
  const f = loaderForms[loaderAktif] || {};
  document.getElementById('loaderPrefix').value = f.loaderPrefix || '';
  document.getElementById('loaderNo').value = f.loaderNo || '';
  document.getElementById('haulerPrefix').value = f.haulerPrefix || '';
  document.getElementById('haulerNo').value = f.haulerNo || '';
  document.getElementById('front').value = f.front || '';
  document.getElementById('dump').value = f.dump || '';
  document.getElementById('material').value = f.material || '';
  document.getElementById('bucket').value = f.bucket || '';
}

function simpanFormLoaderAktif() {
  if (!loaderAktif) return;
  loaderForms[loaderAktif] = {
    loaderPrefix: document.getElementById('loaderPrefix').value,
    loaderNo: document.getElementById('loaderNo').value,
    haulerPrefix: document.getElementById('haulerPrefix').value,
    haulerNo: document.getElementById('haulerNo').value,
    front: document.getElementById('front').value,
    dump: document.getElementById('dump').value,
    material: document.getElementById('material').value,
    bucket: document.getElementById('bucket').value
  };
  localStorage.setItem('loader_forms', JSON.stringify(loaderForms));
}

document.getElementById('addLoaderBtn').addEventListener('click', ()=>{
  simpanFormLoaderAktif();
  tambahLoaderBaru();
});

window.addEventListener('load', ()=>{
  if (Object.keys(loaderForms).length === 0) tambahLoaderBaru();
  else {
    loaderAktif = Object.keys(loaderForms)[0];
    updateLoaderTabs();
    isiFormDariLoader();
  }
});

setInterval(simpanFormLoaderAktif, 2000);

// ==== TABEL ====
function escapeHtml(s){
  return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
}

function render(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  const arr = load();
  const fs = document.getElementById('filterShift').value;
  const fd = document.getElementById('filterDate').value;

  let data = arr;
  if(fs) data = data.filter(x => String(x.shift) === String(fs));
  if(fd) data = data.filter(x => x.tanggal === fd);

  document.getElementById('totalInfo').textContent = `${data.length} data`;

  data.forEach((r, idx) => {
    // --- ðŸ§  COCOKKAN DENGAN MASTER UNIT JIKA ADA ---
    function fixUnit(prefix, codeOrFull) {
      if (!prefix || !MASTER_UNITS[prefix]) return codeOrFull;
      const short = codeOrFull.split('-').pop();
      const found = MASTER_UNITS[prefix].find(x => x.endsWith(`-${short.padStart(3, '0')}`));
      return found || codeOrFull;
    }

    // Perbaiki loader jika ada di master unit
    if (r.loader && r.loader.includes('-')) {
      const prefix = r.loader.split('-')[0];
      r.loader = fixUnit(prefix, r.loader);
    }

    // Perbaiki hauler jika ada di master unit
    if (r.hauler && r.hauler.includes('-')) {
      const prefix = r.hauler.split('-')[0];
      r.hauler = fixUnit(prefix, r.hauler);
    }

    // --- ðŸ§© BUAT BARIS TABEL ---
    const tr = document.createElement('tr');
    const badge = `<span class="badge ${r.shift==1?'s1':'s2'}">${r.shift==1?'Shift 1':'Shift 2'}</span>`;

    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.tanggal}</td>
      <td>${r.jam}</td>
      <td>${badge}</td>
      <td>${escapeHtml(r.checker||'')}</td>
      <td>${escapeHtml(r.loader)}</td>
      <td>${escapeHtml(r.hauler)}</td>
      <td>${escapeHtml(r.front)}</td>
      <td>${escapeHtml(r.dump)}</td>
      <td>${escapeHtml(r.material)}</td>
      <td>${Number(r.bucket)||0}</td>
      <td>${r.lat?r.lat.toFixed(5):'-'}</td>
      <td>${r.lon?r.lon.toFixed(5):'-'}</td>
      <td><button class="btn danger" onclick="hapusModern(${idx},this)">Hapus</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function clearFilter(){
  document.getElementById('filterShift').value = '';
  document.getElementById('filterDate').value = '';
  render();
}


// ==== HAPUS ====
function hapusModern(i,btn){
  showConfirm('Apakah yakin ingin menghapus baris ini?',ok=>{
    if(ok){
      const arr=load();arr.splice(i,1);save(arr);
      if(btn){
        const tr=btn.closest('tr');
        tr.style.opacity='0';tr.style.transform='translateX(-30px)';
        setTimeout(()=>{render();showPopup('Data berhasil dihapus!','success');},300);
      }else{render();showPopup('Data berhasil dihapus!','success');}
    }
  });
}
function hapusSemua(){
  showConfirm('Apakah yakin ingin menghapus semua data?',ok=>{
    if(ok){save([]);render();showPopup('Semua data berhasil dihapus!','success');}
  });
}

// ==== EXPORT CSV ====
function exportCSVFiltered(){
  const arr=load();
  if(!arr.length){showPopup('Belum ada data.','error');return;}
  const fs=document.getElementById('filterShift').value;
  const fd=document.getElementById('filterDate').value;
  let data=arr;
  if(fs)data=data.filter(x=>String(x.shift)===String(fs));
  if(fd)data=data.filter(x=>x.tanggal===fd);
  if(!data.length){showPopup('Data sesuai filter kosong.','error');return;}
  const header=['Tanggal','Jam','Shift','Checker','Loader','Hauler','Location Front','Dumpingan','Material','Jumlah Bucket','Latitude','Longitude'];
  const rows=data.map(r=>[r.tanggal,r.jam,r.shift,(r.checker||''),r.loader,r.hauler,r.front,r.dump,r.material,r.bucket,r.lat,r.lon]);
  const csv=[header,...rows].map(cols=>cols.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`produksi_${Date.now()}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  showPopup('Data berhasil diexport!','success');
}

// ==== CHECKER ====
function setCheckerId(id){
  if(!id)return;
  localStorage.setItem(KEY_CHECKER,id);
  document.getElementById('checkerNow').textContent="Aktif: "+id;
}

function autoShiftUpdate() {
  const info = getShiftAndTanggalKerja();
  SHIFT_AKTIF = info.shift;

  // Update tampilan label shift
  const shiftNow = document.getElementById('shiftNow');
  if (shiftNow) shiftNow.textContent = `Aktif: ${SHIFT_AKTIF}`;

  // Ubah warna tombol sesuai shift aktif
  const btn1 = document.getElementById('btnShift1');
  const btn2 = document.getElementById('btnShift2');
  if (btn1 && btn2) {
    btn1.style.outline = SHIFT_AKTIF === 1 ? '2px solid var(--accent)' : 'none';
    btn2.style.outline = SHIFT_AKTIF === 2 ? '2px solid var(--accent)' : 'none';
  }

  // Nonaktifkan tombol agar tidak bisa diubah manual
  if (btn1) btn1.disabled = true;
  if (btn2) btn2.disabled = true;

  // Update tanggal kerja otomatis
  const tanggalEl = document.getElementById('tanggalNow');
  if (tanggalEl) tanggalEl.value = info.tanggal;
}


// ==== INIT ====
autoShiftUpdate();
setInterval(autoShiftUpdate, 60000); // update tiap 1 menit

render();
(function initChecker(){
  const saved=localStorage.getItem(KEY_CHECKER);
  if(saved){
    document.getElementById('checkerId').value=saved;
    document.getElementById('checkerNow').textContent="Aktif: "+saved;
  }
})();

// ==== GPS ====
if("geolocation"in navigator){
  navigator.geolocation.watchPosition(
    pos=>{
      lokasiTerakhir.lat=pos.coords.latitude;
      lokasiTerakhir.lon=pos.coords.longitude;
      document.getElementById("lokasiInfo").textContent=`GPS: ${lokasiTerakhir.lat.toFixed(5)}, ${lokasiTerakhir.lon.toFixed(5)}`;
    },
    err=>{document.getElementById("lokasiInfo").textContent="GPS Error: "+err.message;},
    {enableHighAccuracy:true,maximumAge:0,timeout:15000}
  );
}else{
  document.getElementById("lokasiInfo").textContent="GPS tidak tersedia";
}
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('âœ… Service Worker aktif, siap offline'))
    .catch(err => console.error('Service Worker gagal:', err));
}
</script>

</script>

</body>
</html>


